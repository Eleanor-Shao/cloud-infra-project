pipeline {
    agent any
    environment {
        PROJECT_ID = "project-440905"
    }
    stages {
        stage('Retrieve Cloud Build Config') {
            steps {
                withCredentials([file(credentialsId: 'cloudbuild-config', variable: 'CLOUD_BUILD_CONFIG')]) {
                    sh 'cp $CLOUD_BUILD_CONFIG ./cloudbuild.yaml'
                }
            }
        }
        stage('Trigger Google Cloud Build') {
            steps {
                withCredentials([file(credentialsId: 'gcp-service-account-json', variable: 'GOOGLE_APPLICATION_CREDENTIALS')]) {
                    sh '''
                    gcloud auth activate-service-account --key-file=${GOOGLE_APPLICATION_CREDENTIALS}
                    gcloud config set project ${PROJECT_ID}

                    # 提交 Cloud Build
                    gcloud builds submit --config=cloudbuild.yaml .
                    '''
                }
            }
        }
    }
}


