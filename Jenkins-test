pipeline {
    agent any
    environment {
        GCLOUD_VM_IP = "34.127.117.116"  // 替换为你的 Google Cloud VM 外部 IP
    }
    stages {
        stage('Run Commands on GCP VM') {
            steps {
                // 使用 Jenkins 中的 SSH 凭据连接到 GCP VM
                withCredentials([sshUserPrivateKey(credentialsId: 'gcp-ssh-key', keyFileVariable: 'SSH_KEY', usernameVariable: 'SSH_USER')]) {
                    sh '''
                    ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no ${SSH_USER}@${GCLOUD_VM_IP} << EOF
                    echo "Successfully connected to GCP VM"

                    # 在这里运行你想要执行的命令。例如：
                    # 激活 Google Cloud 服务账户（需提前上传服务账户凭据文件）
                    gcloud auth activate-service-account --key-file=/path/to/service-account.json
                    gcloud config set project project-440905

                    # 提交 Hadoop 作业到 Dataproc
                    gcloud dataproc jobs submit hadoop \
                      --cluster=hadoop-cluster \
                      --region=us-west1 \
                      --jar gs://hadoop-storage-bucket-project-440905/wordcount-1.0-SNAPSHOT.jar \
                      -- wordcount gs://hadoop-storage-bucket-project-440905/input/input.txt \
                      gs://hadoop-storage-bucket-project-440905/output/

                    # 显示 Hadoop 作业结果
                    gsutil cat gs://hadoop-storage-bucket-project-440905/output/part-*
                    EOF
                    '''
                }
            }
        }
    }
}




